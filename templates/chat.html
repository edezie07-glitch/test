<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HPZ Messenger</title>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700&family=Manrope:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root{--brand:#7c6aff;--brand-dk:#6254e0;--radius:14px;--trans:.18s ease;--font-h:'Syne',sans-serif;--font-b:'Manrope',sans-serif;}
[data-theme="dark"]{--bg:#0f0f17;--sb:#16161f;--sb2:#1c1c27;--card:#1c1c27;--inp:#1c1c27;--recv:#22222f;--sent:var(--brand);--hov:rgba(255,255,255,.05);--act:rgba(124,106,255,.15);--bdr:rgba(255,255,255,.07);--txt:#e8e8f4;--sub:rgba(255,255,255,.45);--mute:rgba(255,255,255,.25);--chat:#13131c;--hdr:#16161f;--ibdr:rgba(255,255,255,.12);--shad:0 4px 24px rgba(0,0,0,.4);--scr:rgba(124,106,255,.3);--online:#22c55e;--warn:#fb923c;}
[data-theme="light"]{--bg:#f2f2fa;--sb:#fff;--sb2:#f7f7fd;--card:#fff;--inp:#f7f7fd;--recv:#fff;--sent:var(--brand);--hov:rgba(0,0,0,.04);--act:rgba(124,106,255,.1);--bdr:rgba(0,0,0,.07);--txt:#1a1a2e;--sub:rgba(0,0,0,.45);--mute:rgba(0,0,0,.3);--chat:#eaeaf4;--hdr:#fff;--ibdr:rgba(0,0,0,.12);--shad:0 4px 24px rgba(0,0,0,.1);--scr:rgba(124,106,255,.4);--online:#22c55e;--warn:#fb923c;}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;overflow:hidden;}
body{font-family:var(--font-b);background:var(--bg);display:flex;height:100vh;color:var(--txt);transition:background .25s,color .25s;}
::-webkit-scrollbar{width:4px;}::-webkit-scrollbar-track{background:transparent;}::-webkit-scrollbar-thumb{background:var(--scr);border-radius:4px;}

/* SIDEBAR */
.sidebar{width:300px;min-width:300px;background:var(--sb);border-right:1px solid var(--bdr);display:flex;flex-direction:column;overflow:hidden;flex-shrink:0;transition:background .25s,border-color .25s;}
.sh{padding:16px 14px 12px;background:var(--sb2);border-bottom:1px solid var(--bdr);}
.sh-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:11px;}
.brand{font-family:var(--font-h);font-size:16px;font-weight:700;color:var(--txt);display:flex;align-items:center;gap:8px;}
.hbtns{display:flex;gap:5px;}
.ib{width:33px;height:33px;border-radius:9px;border:none;background:var(--hov);color:var(--sub);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:15px;transition:background var(--trans),color var(--trans);position:relative;}
.ib:hover{background:rgba(124,106,255,.15);color:var(--brand);}
.ib.on{background:rgba(124,106,255,.2);color:var(--brand);}
.nbadge{position:absolute;top:-3px;right:-3px;background:#ef4444;color:#fff;font-size:9px;font-weight:700;min-width:15px;height:15px;border-radius:8px;display:flex;align-items:center;justify-content:center;padding:0 3px;}
.nbadge.hidden{display:none!important;}
.sinp-w{position:relative;}
.sinp-ic{position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--mute);font-size:13px;pointer-events:none;}
.sinp{width:100%;padding:8px 12px 8px 32px;background:var(--inp);border:1px solid var(--ibdr);border-radius:10px;color:var(--txt);font-size:13px;font-family:var(--font-b);transition:border-color var(--trans),background .25s;}
.sinp::placeholder{color:var(--mute);}.sinp:focus{outline:none;border-color:var(--brand);}

/* Slide Panels */
.spanel{background:var(--sb2);border-bottom:1px solid var(--bdr);max-height:0;overflow:hidden;transition:max-height .3s ease;}
.spanel.open{max-height:250px;overflow-y:auto;}
.ptitle{padding:10px 14px 5px;font-size:10px;font-weight:700;letter-spacing:.1em;color:var(--mute);text-transform:uppercase;}
.req-row{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;border-bottom:1px solid var(--bdr);}
.req-usr{display:flex;align-items:center;gap:8px;}
.req-nm{font-size:13px;font-weight:500;color:var(--txt);}
.req-wh{font-size:11px;color:var(--mute);}
.req-ac{display:flex;gap:4px;}
.sr-row{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;border-bottom:1px solid var(--bdr);transition:background var(--trans);}
.sr-row:hover{background:var(--hov);}
.sr-l{display:flex;align-items:center;gap:8px;}
.sr-nm{font-size:13px;font-weight:500;color:var(--txt);}
.sr-st{font-size:11px;color:var(--mute);}

/* Pills */
.pill{padding:4px 11px;border:none;border-radius:20px;font-size:11.5px;font-weight:600;cursor:pointer;font-family:var(--font-b);transition:opacity var(--trans);}
.pill:hover{opacity:.85;}
.p-add{background:var(--brand);color:#fff;}
.p-msg{background:rgba(124,106,255,.15);color:var(--brand);}
.p-pend{background:var(--hov);color:var(--mute);cursor:default;}
.p-ok{background:#22c55e;color:#fff;}
.p-no{background:var(--hov);color:var(--sub);}

/* Chat List */
.clist{flex:1;overflow-y:auto;padding:6px 0;}
.llabel{padding:10px 14px 3px;font-size:10px;font-weight:700;letter-spacing:.08em;color:var(--mute);text-transform:uppercase;}
.crow{display:flex;align-items:center;gap:10px;padding:9px 12px;margin:1px 5px;border-radius:11px;cursor:pointer;transition:background var(--trans);position:relative;}
.crow:hover{background:var(--hov);}
.crow.active{background:var(--act);}
.crow.active::before{content:'';position:absolute;left:0;top:22%;height:56%;width:3px;border-radius:3px;background:var(--brand);}
.crow .unread{position:absolute;right:10px;top:50%;transform:translateY(-50%);background:var(--brand);color:#fff;font-size:10px;font-weight:700;min-width:18px;height:18px;border-radius:9px;display:flex;align-items:center;justify-content:center;padding:0 4px;}
.cmeta{flex:1;min-width:0;}
.cnrow{display:flex;justify-content:space-between;align-items:center;}
.cuname{font-size:13.5px;font-weight:600;color:var(--txt);}
.cts{font-size:10.5px;color:var(--mute);}
.cprev{font-size:12px;color:var(--sub);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:1px;}
.lempty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:30px 20px;gap:6px;text-align:center;color:var(--mute);font-size:13px;}

/* Avatar */
.av{width:38px;height:38px;border-radius:12px;background:var(--brand);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:15px;flex-shrink:0;overflow:hidden;position:relative;}
.av img{width:100%;height:100%;object-fit:cover;}
.av.sm{width:32px;height:32px;border-radius:9px;font-size:12px;}
.av.lg{width:44px;height:44px;border-radius:13px;font-size:18px;}
.av.xl{width:64px;height:64px;border-radius:18px;font-size:26px;}
.av .online-dot{position:absolute;bottom:0;right:0;width:10px;height:10px;background:var(--online);border:2px solid var(--sb);border-radius:50%;}
.av.lg .online-dot{width:12px;height:12px;}

/* SETTINGS DRAWER */
.sov{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:800;opacity:0;pointer-events:none;transition:opacity .25s;}
.sov.open{opacity:1;pointer-events:all;}
.sdraw{position:fixed;top:0;right:0;height:100%;width:340px;background:var(--bg);border-left:1px solid var(--bdr);z-index:810;display:flex;flex-direction:column;transform:translateX(100%);transition:transform .3s cubic-bezier(.4,0,.2,1),background .25s;box-shadow:-8px 0 40px rgba(0,0,0,.3);}
.sdraw.open{transform:translateX(0);}
.shead{padding:20px 20px 16px;border-bottom:1px solid var(--bdr);display:flex;align-items:center;gap:12px;background:var(--sb2);}
.shead h2{font-family:var(--font-h);font-size:18px;font-weight:700;color:var(--txt);flex:1;}
.closebtn{width:30px;height:30px;border-radius:8px;border:none;background:var(--hov);color:var(--sub);cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;transition:background var(--trans);}
.closebtn:hover{background:rgba(239,68,68,.15);color:#ef4444;}
.sbody{flex:1;overflow-y:auto;padding:10px 0 20px;}
.ssec{padding:14px 20px 6px;}
.ssec-t{font-size:10px;font-weight:700;letter-spacing:.1em;color:var(--mute);text-transform:uppercase;margin-bottom:10px;}
.pcard{background:var(--card);border:1px solid var(--bdr);border-radius:var(--radius);padding:16px;display:flex;align-items:center;gap:14px;margin-bottom:8px;transition:background .25s,border-color .25s;}
.pinfo{flex:1;min-width:0;}
.pname{font-family:var(--font-h);font-size:16px;font-weight:700;color:var(--txt);}
.pstat{font-size:12px;color:var(--sub);margin-top:2px;}
.ef{display:flex;flex-direction:column;gap:4px;margin-bottom:10px;}
.ef label{font-size:11px;font-weight:600;color:var(--mute);text-transform:uppercase;letter-spacing:.06em;}
.ei{padding:9px 12px;background:var(--inp);border:1px solid var(--ibdr);border-radius:9px;color:var(--txt);font-size:13px;font-family:var(--font-b);transition:border-color var(--trans),background .25s;}
.ei:focus{outline:none;border-color:var(--brand);}
.ei::placeholder{color:var(--mute);}
.savebtn{width:100%;padding:10px;background:var(--brand);color:#fff;border:none;border-radius:10px;font-size:13.5px;font-weight:600;font-family:var(--font-b);cursor:pointer;transition:background var(--trans);margin-top:4px;}
.savebtn:hover{background:var(--brand-dk);}
.srow{display:flex;align-items:center;justify-content:space-between;padding:11px 14px;background:var(--card);border:1px solid var(--bdr);border-radius:var(--radius);margin-bottom:6px;transition:background .25s,border-color .25s;}
.sleft{display:flex;align-items:center;gap:11px;}
.sic{width:34px;height:34px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:17px;}
.sic.pu{background:rgba(124,106,255,.15);}
.sic.gr{background:rgba(34,197,94,.15);}
.sic.or{background:rgba(251,146,60,.15);}
.sic.re{background:rgba(239,68,68,.12);}
.sic.bl{background:rgba(59,130,246,.15);}
.sic.ye{background:rgba(234,179,8,.15);}
.slb{font-size:13.5px;font-weight:500;color:var(--txt);}
.sdb{font-size:11px;color:var(--mute);margin-top:1px;}
.tog{width:40px;height:22px;background:rgba(255,255,255,.1);border-radius:11px;border:none;cursor:pointer;position:relative;transition:background var(--trans);flex-shrink:0;}
[data-theme="light"] .tog{background:rgba(0,0,0,.1);}
.tog.on{background:var(--brand);}
.tog::after{content:'';position:absolute;top:3px;left:3px;width:16px;height:16px;border-radius:50%;background:rgba(255,255,255,.6);transition:transform var(--trans),background var(--trans);}
[data-theme="light"] .tog::after{background:rgba(0,0,0,.4);}
.tog.on::after{transform:translateX(18px);background:#fff;}
.dangbtn{width:100%;padding:11px;background:rgba(239,68,68,.1);color:#ef4444;border:1px solid rgba(239,68,68,.2);border-radius:10px;font-size:13.5px;font-weight:600;font-family:var(--font-b);cursor:pointer;display:flex;align-items:center;justify-content:center;gap:7px;transition:background var(--trans);margin-top:2px;}
.dangbtn:hover{background:rgba(239,68,68,.18);}

/* MAIN */
.main{flex:1;display:flex;flex-direction:column;overflow:hidden;background:var(--chat);transition:background .25s;}
.chdr{padding:13px 18px;min-height:62px;background:var(--hdr);border-bottom:1px solid var(--bdr);display:flex;align-items:center;gap:12px;transition:background .25s,border-color .25s;}
.chdr-info{flex:1;min-width:0;}
.chdr-nm{font-family:var(--font-h);font-size:15px;font-weight:700;color:var(--txt);}
.chdr-sub{font-size:11.5px;color:var(--mute);margin-top:1px;}
.chdr-sub.online{color:var(--online);}
.chdr-actions{display:flex;gap:6px;}
.chdr-btn{width:32px;height:32px;border-radius:8px;border:none;background:var(--hov);color:var(--sub);cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;transition:background var(--trans);}
.chdr-btn:hover{background:rgba(124,106,255,.15);color:var(--brand);}

/* Pinned Messages Banner */
.pinned-banner{background:rgba(251,146,60,.08);border-bottom:1px solid rgba(251,146,60,.2);padding:8px 18px;display:none;cursor:pointer;transition:background var(--trans);}
.pinned-banner:hover{background:rgba(251,146,60,.12);}
.pinned-banner.show{display:flex;align-items:center;gap:8px;}
.pinned-banner .pin-icon{color:var(--warn);font-size:14px;}
.pinned-banner .pin-text{flex:1;font-size:12px;color:var(--txt);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

/* Message Area */
.marea{flex:1;overflow-y:auto;padding:16px 18px 8px;display:flex;flex-direction:column;gap:3px;}
.daydiv{text-align:center;margin:10px 0 5px;}
.daydiv span{background:rgba(124,106,255,.1);color:var(--mute);font-size:11px;font-weight:500;padding:3px 10px;border-radius:20px;}

/* Message Groups */
.mgrp{display:flex;flex-direction:column;position:relative;}
.mgrp.sent{align-items:flex-end;}
.mgrp.recv{align-items:flex-start;}
.mgrp+.mgrp{margin-top:4px;}
.mfrom{font-size:11px;font-weight:700;color:var(--brand);margin-bottom:3px;margin-left:2px;}

/* Message Bubble */
.bub{max-width:64%;padding:10px 14px;border-radius:var(--radius);font-size:13.5px;line-height:1.55;word-break:break-word;position:relative;transition:background .25s;cursor:pointer;}
.mgrp.sent .bub{background:var(--sent);color:#fff;border-bottom-right-radius:4px;}
.mgrp.recv .bub{background:var(--recv);color:var(--txt);border-bottom-left-radius:4px;box-shadow:0 1px 4px rgba(0,0,0,.1);}
.bub:hover .msg-actions{opacity:1;}
.bub.pinned::before{content:'üìå';position:absolute;top:-8px;right:-8px;font-size:16px;}
.bub.edited .mts::after{content:' (edited)';opacity:.7;}

/* Reply Preview in Bubble */
.reply-prev{background:rgba(0,0,0,.15);border-left:3px solid rgba(255,255,255,.3);padding:6px 10px;border-radius:6px;margin-bottom:6px;font-size:12px;}
.mgrp.recv .reply-prev{background:rgba(0,0,0,.05);border-left-color:var(--brand);}
.reply-prev-from{font-weight:600;color:var(--brand);margin-bottom:2px;}
.reply-prev-text{opacity:.8;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

/* Message Actions */
.msg-actions{position:absolute;top:-12px;right:8px;background:var(--card);border:1px solid var(--bdr);border-radius:8px;padding:2px;display:flex;gap:2px;opacity:0;transition:opacity var(--trans);box-shadow:var(--shad);z-index:10;}
.mgrp.sent .msg-actions{right:auto;left:8px;}
.msg-act{width:28px;height:28px;border:none;background:transparent;color:var(--sub);cursor:pointer;font-size:14px;border-radius:6px;display:flex;align-items:center;justify-content:center;transition:background var(--trans);}
.msg-act:hover{background:var(--hov);color:var(--txt);}

/* Reactions */
.reactions{display:flex;flex-wrap:wrap;gap:4px;margin-top:4px;}
.reaction{background:rgba(124,106,255,.12);border:1px solid rgba(124,106,255,.2);padding:2px 8px;border-radius:12px;font-size:13px;cursor:pointer;display:flex;align-items:center;gap:4px;transition:all var(--trans);}
.reaction:hover{background:rgba(124,106,255,.18);}
.reaction.user-reacted{background:rgba(124,106,255,.25);border-color:rgba(124,106,255,.4);}
.reaction .count{font-size:11px;font-weight:600;color:var(--txt);}

/* Emoji Picker for Reactions */
.react-picker{position:absolute;bottom:100%;right:0;background:var(--card);border:1px solid var(--bdr);border-radius:10px;padding:8px;display:none;flex-wrap:wrap;gap:4px;width:200px;box-shadow:var(--shad);z-index:100;margin-bottom:4px;}
.react-picker.show{display:flex;}
.react-emoji{font-size:20px;cursor:pointer;padding:4px;border-radius:6px;transition:background var(--trans);}
.react-emoji:hover{background:var(--hov);}

.bub img{max-width:240px;max-height:240px;border-radius:8px;display:block;cursor:pointer;margin-bottom:4px;}
.mts{font-size:10px;display:block;margin-top:4px;}
.mgrp.sent .mts{color:rgba(255,255,255,.55);text-align:right;}
.mgrp.recv .mts{color:var(--mute);}

/* Empty State */
.ces{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;color:var(--mute);text-align:center;}
.ces .big{font-size:52px;margin-bottom:4px;}
.ces h3{font-family:var(--font-h);font-size:18px;color:var(--txt);}
.ces p{font-size:13px;}

/* Typing Bar */
.tybar{display:flex;align-items:center;gap:5px;padding:6px 18px;min-height:26px;font-size:12px;color:var(--mute);}
.tdot{width:6px;height:6px;background:var(--mute);border-radius:50%;animation:tdot 1.2s infinite;}
.tdot:nth-child(2){animation-delay:.2s;}.tdot:nth-child(3){animation-delay:.4s;}
@keyframes tdot{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-5px)}}

/* Reply Bar */
.reply-bar{background:rgba(124,106,255,.08);border-top:1px solid rgba(124,106,255,.2);padding:8px 18px;display:none;align-items:center;gap:10px;}
.reply-bar.show{display:flex;}
.reply-bar-content{flex:1;min-width:0;}
.reply-bar-from{font-size:11px;font-weight:600;color:var(--brand);}
.reply-bar-text{font-size:12px;color:var(--txt);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:2px;}
.reply-bar-close{width:24px;height:24px;border:none;background:transparent;color:var(--mute);cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;}
.reply-bar-close:hover{color:var(--txt);}

/* Emoji Picker */
.epick{position:absolute;bottom:62px;left:14px;background:var(--card);border:1px solid var(--bdr);border-radius:var(--radius);padding:10px;display:none;flex-wrap:wrap;gap:5px;width:220px;z-index:100;box-shadow:var(--shad);}
.epick.open{display:flex;}
.eo{font-size:21px;cursor:pointer;padding:3px;border-radius:6px;transition:background var(--trans);}
.eo:hover{background:var(--hov);}

/* Input Area */
.iarea{padding:10px 14px;background:var(--hdr);border-top:1px solid var(--bdr);display:flex;align-items:flex-end;gap:8px;position:relative;transition:background .25s,border-color .25s;}
.isb{width:36px;height:36px;border-radius:50%;border:none;background:var(--hov);color:var(--sub);cursor:pointer;font-size:16px;flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:background var(--trans),color var(--trans);margin-bottom:2px;}
.isb:hover{background:rgba(124,106,255,.15);color:var(--brand);}
#msgInput{flex:1;padding:10px 14px;background:var(--inp);border:1px solid var(--ibdr);border-radius:20px;color:var(--txt);font-size:13.5px;font-family:var(--font-b);outline:none;resize:none;line-height:1.4;max-height:110px;transition:border-color var(--trans),background .25s;}
#msgInput:focus{border-color:var(--brand);}
#msgInput::placeholder{color:var(--mute);}
.sndbtn{width:38px;height:38px;border-radius:50%;border:none;background:var(--brand);color:#fff;font-size:17px;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:background var(--trans),transform var(--trans);margin-bottom:2px;}
.sndbtn:hover{background:var(--brand-dk);transform:scale(1.07);}
.sndbtn:active{transform:scale(.94);}

/* Search Panel */
.search-panel{background:var(--sb2);border-bottom:1px solid var(--bdr);max-height:0;overflow:hidden;transition:max-height .3s ease;}
.search-panel.open{max-height:300px;overflow-y:auto;}
.search-results{padding:10px;}
.search-msg{padding:8px 12px;background:var(--card);border:1px solid var(--bdr);border-radius:8px;margin-bottom:6px;cursor:pointer;transition:background var(--trans);}
.search-msg:hover{background:var(--hov);}
.search-msg-from{font-size:11px;font-weight:600;color:var(--brand);margin-bottom:4px;}
.search-msg-content{font-size:13px;color:var(--txt);}
.search-msg-time{font-size:10px;color:var(--mute);margin-top:4px;}

/* TOAST */
.tstack{position:fixed;bottom:22px;left:50%;transform:translateX(-50%);z-index:9000;display:flex;flex-direction:column;gap:7px;align-items:center;pointer-events:none;}
.toast{background:var(--card);color:var(--txt);padding:9px 18px;border-radius:24px;font-size:12.5px;font-family:var(--font-b);box-shadow:var(--shad);border:1px solid var(--bdr);opacity:0;transform:translateY(10px);transition:opacity .2s,transform .2s;}
.toast.show{opacity:1;transform:translateY(0);}
.toast.ok{border-left:3px solid #22c55e;}
.toast.err{border-left:3px solid #ef4444;}
.toast.info{border-left:3px solid var(--brand);}

/* Context Menu */
.ctx-menu{position:fixed;background:var(--card);border:1px solid var(--bdr);border-radius:10px;padding:4px;min-width:160px;box-shadow:var(--shad);z-index:1000;display:none;}
.ctx-menu.show{display:block;}
.ctx-item{padding:8px 12px;border-radius:6px;font-size:13px;color:var(--txt);cursor:pointer;display:flex;align-items:center;gap:8px;transition:background var(--trans);}
.ctx-item:hover{background:var(--hov);}
.ctx-item.danger{color:#ef4444;}
.ctx-item.danger:hover{background:rgba(239,68,68,.1);}

/* MOBILE */
.mov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:700;}
.mov.show{display:block;}
.mtog{display:none;position:fixed;top:10px;left:10px;z-index:750;width:38px;height:38px;border-radius:11px;border:none;background:var(--brand);color:#fff;font-size:18px;cursor:pointer;align-items:center;justify-content:center;}
@media(max-width:720px){
  .mtog{display:flex;}
  .mov{display:none;}
  .mov.show{display:block;}
  .sidebar{position:fixed;left:0;top:0;height:100%;z-index:720;width:280px;transform:translateX(-100%);transition:transform .28s ease;}
  .sidebar.open{transform:translateX(0);}
  .main{width:100%;}
  .chdr{padding-left:56px;}
  .bub{max-width:80%;}
  .sdraw{width:100%;}
}
</style>
</head>
<body>
<div class="mov" id="mov" onclick="closeSB()"></div>
<button class="mtog" onclick="toggleSB()">‚ò∞</button>

<!-- Context Menu -->
<div class="ctx-menu" id="ctxMenu">
  <div class="ctx-item" onclick="replyToMsgCtx()">‚Ü©Ô∏è Reply</div>
  <div class="ctx-item" onclick="editMsgCtx()">‚úèÔ∏è Edit</div>
  <div class="ctx-item" onclick="pinMsgCtx()">üìå Pin</div>
  <div class="ctx-item danger" onclick="deleteMsgCtx()">üóëÔ∏è Delete</div>
</div>

<!-- SIDEBAR -->
<aside class="sidebar" id="sidebar">
  <div class="sh">
    <div class="sh-top">
      <div class="brand"><img src="/static/hepozy_logo.jpg" alt="HPZ" style="width:40px;height:40px;object-fit:cover;border-radius:50%;" onerror="this.style.display='none'"></div>
      <div class="hbtns">
        <button class="ib" id="rqBtn" onclick="toggleP('rqPanel')" title="Requests">üîî<span class="nbadge hidden" id="rqBadge">0</span></button>
        <button class="ib" onclick="openSettings()" title="Settings">‚öôÔ∏è</button>
      </div>
    </div>
    <div class="sinp-w">
      <span class="sinp-ic">üîç</span>
      <input class="sinp" id="sinp" type="text" placeholder="Search users‚Ä¶" oninput="handleSearch(this.value)" autocomplete="off">
    </div>
  </div>
  <div class="spanel" id="rqPanel">
    <div class="ptitle">Friend Requests</div>
    <div id="rqList"><div class="lempty" style="padding:12px;">No pending requests</div></div>
  </div>
  <div class="spanel" id="srPanel">
    <div id="srList"></div>
  </div>
  <div class="clist" id="clist">
    <div class="llabel">Conversations</div>
    <div class="lempty" id="cempty">üë•<br>Search for friends to chat</div>
  </div>
</aside>

<!-- MAIN -->
<main class="main">
  <div class="chdr">
    <div class="av lg" id="chav">üí¨</div>
    <div class="chdr-info">
      <div class="chdr-nm" id="chnm">HPZ Messenger</div>
      <div class="chdr-sub" id="chsub">Select a conversation</div>
    </div>
    <div class="chdr-actions">
      <button class="chdr-btn" id="searchBtn" onclick="toggleSearch()" title="Search messages" style="display:none;">üîç</button>
      <button class="chdr-btn" id="pinnedBtn" onclick="showPinned()" title="Pinned messages" style="display:none;">üìå</button>
    </div>
  </div>
  
  <div class="search-panel" id="searchPanel">
    <div style="padding:10px 18px;">
      <input class="sinp" id="msgSearch" type="text" placeholder="Search messages‚Ä¶" oninput="searchMsgs(this.value)" style="width:100%;padding-left:12px;">
    </div>
    <div class="search-results" id="searchResults"></div>
  </div>
  
  <div class="pinned-banner" id="pinnedBanner" onclick="showPinned()">
    <span class="pin-icon">üìå</span>
    <span class="pin-text" id="pinnedText">1 pinned message</span>
  </div>
  
  <div class="marea" id="marea">
    <div class="ces"><div class="big">üí¨</div><h3>No chat open</h3><p>Select a friend from the sidebar</p></div>
  </div>
  
  <div class="tybar" id="tybar" style="display:none;">
    <div class="tdot"></div><div class="tdot"></div><div class="tdot"></div>
    <span id="tytxt" style="margin-left:4px;"></span>
  </div>
  
  <div class="reply-bar" id="replyBar">
    <div style="color:var(--brand);font-size:18px;">‚Ü©Ô∏è</div>
    <div class="reply-bar-content">
      <div class="reply-bar-from" id="replyFrom">Username</div>
      <div class="reply-bar-text" id="replyText">Message content...</div>
    </div>
    <button class="reply-bar-close" onclick="cancelReply()">‚úï</button>
  </div>
  
  <div class="epick" id="epick">
    <span class="eo" onclick="ins('üòÄ')">üòÄ</span><span class="eo" onclick="ins('üòÇ')">üòÇ</span>
    <span class="eo" onclick="ins('üòç')">üòç</span><span class="eo" onclick="ins('üî•')">üî•</span>
    <span class="eo" onclick="ins('üëç')">üëç</span><span class="eo" onclick="ins('‚ù§Ô∏è')">‚ù§Ô∏è</span>
    <span class="eo" onclick="ins('üò≠')">üò≠</span><span class="eo" onclick="ins('üéâ')">üéâ</span>
    <span class="eo" onclick="ins('üòé')">üòé</span><span class="eo" onclick="ins('ü§î')">ü§î</span>
    <span class="eo" onclick="ins('üíÄ')">üíÄ</span><span class="eo" onclick="ins('‚úÖ')">‚úÖ</span>
    <span class="eo" onclick="ins('üôè')">üôè</span><span class="eo" onclick="ins('üò§')">üò§</span>
  </div>
  
  <div class="iarea">
    <input type="file" id="imgInp" accept="image/*" style="display:none" onchange="uploadImg(this)">
    <button class="isb" onclick="document.getElementById('imgInp').click()" title="Attach">üìé</button>
    <button class="isb" onclick="toggleEmoji()" title="Emoji">üòä</button>
    <textarea id="msgInput" rows="1" placeholder="Type a message‚Ä¶"
      oninput="autoR(this);doTyping();"
      onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();if(editingMsgId){saveEdit();}else{sendMsg();}}"></textarea>
    <button class="sndbtn" onclick="sendMsg()">‚û§</button>
  </div>
</main>

<!-- SETTINGS (unchanged) -->
<div class="sov" id="sov" onclick="closeSettings()"></div>
<div class="sdraw" id="sdraw">
  <div class="shead">
    <span style="font-size:20px;">‚öôÔ∏è</span>
    <h2>Settings</h2>
    <button class="closebtn" onclick="closeSettings()">‚úï</button>
  </div>
  <div class="sbody">
    <div class="ssec">
      <div class="ssec-t">My Profile</div>
      <div class="pcard">
        <div class="av xl" id="sav">{{ user.username[0]|upper }}</div>
        <div class="pinfo">
          <div class="pname" id="snm">{{ user.username }}</div>
          <div class="pstat" id="sst">Available</div>
        </div>
      </div>
      <div class="ef"><label>Display Name</label><input class="ei" id="eun" value="{{ user.username }}"></div>
      <div class="ef"><label>Status</label><input class="ei" id="est" value="Available"></div>
      <div class="ef"><label>Bio</label><input class="ei" id="ebio" placeholder="Tell people about yourself‚Ä¶"></div>
      <button class="savebtn" onclick="saveProfile()">üíæ Save Profile</button>
    </div>
    <div class="ssec" style="margin-top:6px;">
      <div class="ssec-t">Appearance</div>
      <div class="srow">
        <div class="sleft"><div class="sic pu">üåô</div><div><div class="slb">Dark Mode</div><div class="sdb">Toggle dark / light theme</div></div></div>
        <button class="tog on" id="tDark" onclick="toggleTheme()"></button>
      </div>
    </div>
    <div class="ssec" style="margin-top:6px;">
      <div class="ssec-t">Notifications</div>
      <div class="srow">
        <div class="sleft"><div class="sic gr">üîî</div><div><div class="slb">Sound Alerts</div><div class="sdb">Play sound on new messages</div></div></div>
        <button class="tog on" id="tSound" onclick="toggleSetting('sound','tSound')"></button>
      </div>
    </div>
    <div class="ssec" style="margin-top:6px;">
      <div class="ssec-t">Account</div>
      <button class="dangbtn" onclick="logout()">üö™ Log Out</button>
    </div>
  </div>
</div>

<div class="tstack" id="tstack"></div>

<script>
const ME_ID = {{ user_id }};
const ME_NAME = '{{ user.username }}';
let socket=null,currentChatId=null,currentFriendId=null,friends=[],pendingReqs=[],searchTimer=null,typingTimer=null;
let prefs={theme:'dark',sound:true};
let replyToMsg=null,contextMsg=null,onlineUsers=new Set();

(function boot(){
  loadPrefs(); connectSocket(); loadFriends(); loadRequests();
  document.addEventListener('click', hideCtxMenu);
})();

function loadPrefs(){
  try{const s=localStorage.getItem('hpz_prefs');if(s)prefs={...prefs,...JSON.parse(s)};}catch(e){}
  applyTheme();
  document.getElementById('tDark').classList.toggle('on',prefs.theme==='dark');
  document.getElementById('tSound').classList.toggle('on',prefs.sound);
}
function savePrefs(){localStorage.setItem('hpz_prefs',JSON.stringify(prefs));}
function applyTheme(){document.documentElement.setAttribute('data-theme',prefs.theme);}
function toggleTheme(){
  prefs.theme=prefs.theme==='dark'?'light':'dark';
  applyTheme();
  document.getElementById('tDark').classList.toggle('on',prefs.theme==='dark');
  savePrefs();
  toast(prefs.theme==='dark'?'üåô Dark mode':'‚òÄÔ∏è Light mode','info');
}
function toggleSetting(key,btnId){
  prefs[key]=!prefs[key];
  document.getElementById(btnId).classList.toggle('on',prefs[key]);
  savePrefs();
}

function openSettings(){document.getElementById('sov').classList.add('open');document.getElementById('sdraw').classList.add('open');}
function closeSettings(){document.getElementById('sov').classList.remove('open');document.getElementById('sdraw').classList.remove('open');}

async function saveProfile(){
  const un=document.getElementById('eun').value.trim();
  const st=document.getElementById('est').value.trim();
  const bio=document.getElementById('ebio').value.trim();
  try{
    const r=await fetch('/api/profile',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:un,status:st,bio})});
    const d=await r.json();
    if(d.success){
      document.getElementById('snm').textContent=un||ME_NAME;
      document.getElementById('sst').textContent=st||'Available';
      toast('‚úÖ Profile saved!','ok');
    }else toast(d.error||'Failed','err');
  }catch(e){toast('Failed','err');}
}

function connectSocket(){
  socket=io({withCredentials:true,transports:['polling','websocket']});
  socket.on('connect',()=>{if(currentChatId)socket.emit('join_chat',{chat_id:currentChatId});});
  socket.on('disconnect',()=>{});
  socket.on('new_message',(msg)=>{
    if(currentChatId&&msg.chat_id===currentChatId)appendMsg(msg);
    if(prefs.sound&&msg.sender_id!==ME_ID)beep();
    updatePrev(msg);
  });
  socket.on('message_edited',(msg)=>{
    if(currentChatId&&msg.chat_id===currentChatId)updateMsgInDOM(msg);
  });
  socket.on('message_deleted',(data)=>{
    if(currentChatId&&data.chat_id===currentChatId){
      const el=document.querySelector(`[data-msg-id="${data.id}"]`);
      if(el)el.remove();
    }
  });
  socket.on('message_pinned',(data)=>{
    if(currentChatId&&data.chat_id===currentChatId){
      const el=document.querySelector(`[data-msg-id="${data.id}"] .bub`);
      if(el)el.classList.toggle('pinned',data.is_pinned);
      updatePinnedBanner();
    }
  });
  socket.on('message_reaction',(data)=>{
    if(currentChatId&&data.chat_id===currentChatId)updateMsgInDOM(data.message);
  });
  socket.on('user_online',(data)=>{
    if(data.online)onlineUsers.add(data.user_id);
    else onlineUsers.delete(data.user_id);
    updateOnlineStatus();
  });
  socket.on('typing_start',({username})=>showTyping(username));
  socket.on('typing_stop',hideTyping);
  socket.on('error',(e)=>toast(e.message||'Socket error','err'));
}

function sendMsg(){
  const inp=document.getElementById('msgInput');
  const c=inp.value.trim();
  if(!c)return;
  if(!socket?.connected){toast('Not connected','err');return;}
  if(!currentChatId){toast('Select a chat first','err');return;}
  
  const data={
    chat_id:currentChatId,
    content:c,
    message_type:'text'
  };
  if(replyToMsg)data.reply_to_id=replyToMsg.id;
  
  socket.emit('send_message',data);
  inp.value='';inp.style.height='';closeEmoji();cancelReply();
}

async function loadMsgs(chatId){
  try{
    const r=await fetch(`/api/messages/${chatId}`);
    const d=await r.json();
    const area=document.getElementById('marea');
    area.innerHTML='';
    if(!d.success||!d.messages.length){
      area.innerHTML='<div class="ces"><div class="big">üëã</div><h3>Say hello!</h3><p>No messages yet</p></div>';
      return;
    }
    let ld='';
    d.messages.forEach(m=>{
      const dy=dayLabel(m.created_at);
      if(dy!==ld){area.insertAdjacentHTML('beforeend',`<div class="daydiv"><span>${dy}</span></div>`);ld=dy;}
      appendMsg(m,false);
    });
    scrollBot();
    updatePinnedBanner();
  }catch(e){console.error(e);}
}

function appendMsg(msg,scroll=true){
  const area=document.getElementById('marea');
  const em=area.querySelector('.ces');if(em)em.remove();
  const isSent=msg.sender_id===ME_ID;
  const g=document.createElement('div');
  g.className=`mgrp ${isSent?'sent':'recv'}`;
  g.setAttribute('data-msg-id',msg.id);
  
  let inner='';
  if(!isSent)inner+=`<div class="mfrom">${esc(msg.sender_username)}</div>`;
  
  let body='';
  if(msg.reply_to){
    body+=`<div class="reply-prev">
      <div class="reply-prev-from">${esc(msg.reply_to.sender_username)}</div>
      <div class="reply-prev-text">${esc(msg.reply_to.content)}</div>
    </div>`;
  }
  
  if(msg.message_type==='image'){
    body+=`<img src="${msg.content}" alt="img" onclick="window.open('${msg.content}','_blank')">`;
  }else if(!msg.is_deleted){
    body+=esc(msg.content).replace(/\n/g,'<br>');
  }else{
    body+='<em style="opacity:.5">[Message deleted]</em>';
  }
  
  const bubClass=`bub${msg.is_pinned?' pinned':''}${msg.is_edited?' edited':''}`;
  inner+=`<div class="${bubClass}" oncontextmenu="showCtxMenu(event,${msg.id},${isSent})">`;
  inner+=body;
  inner+=`<span class="mts">${fmtTime(msg.created_at)}</span>`;
  
  if(isSent&&!msg.is_deleted){
    inner+=`<div class="msg-actions">
      <button class="msg-act" data-action="reply" data-msg-id="${msg.id}">‚Ü©Ô∏è</button>
      <button class="msg-act" data-action="edit" data-msg-id="${msg.id}">‚úèÔ∏è</button>
      <button class="msg-act" data-action="pin" data-msg-id="${msg.id}">üìå</button>
      <button class="msg-act" data-action="delete" data-msg-id="${msg.id}">üóëÔ∏è</button>
    </div>`;
  }else if(!isSent&&!msg.is_deleted){
    inner+=`<div class="msg-actions">
      <button class="msg-act" data-action="reply" data-msg-id="${msg.id}">‚Ü©Ô∏è</button>
      <button class="msg-act" data-action="react" data-msg-id="${msg.id}">üòä</button>
      <button class="msg-act" data-action="pin" data-msg-id="${msg.id}">üìå</button>
    </div>`;
  }
  
  inner+=`</div>`;
  
  if(msg.reactions&&Object.keys(msg.reactions).length>0){
    inner+=`<div class="reactions">`;
    for(const[emoji,count]of Object.entries(msg.reactions)){
      const userReacted=msg.user_reactions&&msg.user_reactions.includes(emoji);
      inner+=`<div class="reaction${userReacted?' user-reacted':''}" data-emoji="${emoji}">
        <span>${emoji}</span><span class="count">${count}</span>
      </div>`;
    }
    inner+=`</div>`;
  }
  
  g.innerHTML=inner;
  area.appendChild(g);
  if(scroll)scrollBot();
}

function updateMsgInDOM(msg){
  const el=document.querySelector(`[data-msg-id="${msg.id}"]`);
  if(!el)return;
  el.outerHTML='';
  appendMsg(msg,false);
}

function scrollBot(){const a=document.getElementById('marea');a.scrollTop=a.scrollHeight;}

async function uploadImg(inp){
  const f=inp.files[0];if(!f)return;
  if(!currentChatId){toast('Select a chat first','err');inp.value='';return;}
  const fd=new FormData();fd.append('image',f);
  try{
    const r=await fetch('/api/upload/image',{method:'POST',body:fd});
    const d=await r.json();
    if(d.success)socket.emit('send_message',{chat_id:currentChatId,content:d.url,message_type:'image'});
    else toast(d.error||'Upload failed','err');
  }catch(e){toast('Upload failed','err');}
  inp.value='';
}

// Reply functions
function setReply(id,from,content){
  replyToMsg={id,from,content};
  document.getElementById('replyFrom').textContent=from;
  document.getElementById('replyText').textContent=content;
  document.getElementById('replyBar').classList.add('show');
  document.getElementById('msgInput').focus();
}
function cancelReply(){
  replyToMsg=null;
  document.getElementById('replyBar').classList.remove('show');
}

// Edit functions
let editingMsgId=null;
function startEdit(id,content){
  editingMsgId=id;
  const inp=document.getElementById('msgInput');
  inp.value=content.replace(/<br>/g,'\n');
  inp.focus();
  toast('‚úèÔ∏è Editing message - press Enter to save','info');
}
async function saveEdit(){
  if(!editingMsgId)return;
  const inp=document.getElementById('msgInput');
  const content=inp.value.trim();
  if(!content)return;
  try{
    const r=await fetch(`/api/messages/${editingMsgId}/edit`,{
      method:'PUT',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({content})
    });
    const d=await r.json();
    if(d.success){
      inp.value='';inp.style.height='';
      editingMsgId=null;
      toast('‚úÖ Message updated','ok');
    }else toast(d.error,'err');
  }catch(e){toast('Failed','err');}
}

// Delete function
async function confirmDelete(id){
  if(!confirm('Delete this message?'))return;
  try{
    const r=await fetch(`/api/messages/${id}/delete`,{method:'DELETE'});
    const d=await r.json();
    if(!d.success)toast(d.error,'err');
  }catch(e){toast('Failed','err');}
}

// Pin function
async function togglePin(id){
  try{
    const r=await fetch(`/api/messages/${id}/pin`,{method:'POST'});
    const d=await r.json();
    if(d.success){
      toast(d.is_pinned?'üìå Message pinned':'üìå Message unpinned','info');
      updatePinnedBanner();
    }else toast(d.error,'err');
  }catch(e){toast('Failed','err');}
}

async function updatePinnedBanner(){
  if(!currentChatId)return;
  try{
    const r=await fetch(`/api/messages/pinned/${currentChatId}`);
    const d=await r.json();
    const banner=document.getElementById('pinnedBanner');
    if(d.success&&d.messages.length>0){
      document.getElementById('pinnedText').textContent=
        d.messages.length===1?'1 pinned message':`${d.messages.length} pinned messages`;
      banner.classList.add('show');
    }else{
      banner.classList.remove('show');
    }
  }catch(e){}
}

async function showPinned(){
  if(!currentChatId)return;
  try{
    const r=await fetch(`/api/messages/pinned/${currentChatId}`);
    const d=await r.json();
    if(d.success&&d.messages.length>0){
      const list=d.messages.map(m=>`‚Ä¢ ${m.content.substring(0,60)}`).join('\n');
      alert(`Pinned Messages:\n\n${list}`);
    }else{
      toast('No pinned messages','info');
    }
  }catch(e){toast('Failed','err');}
}

// Reactions
function showReactPicker(id,event){
  event.stopPropagation();
  const picker=document.createElement('div');
  picker.className='react-picker show';
  picker.style.position='absolute';
  picker.style.left=`${event.clientX}px`;
  picker.style.top=`${event.clientY-100}px`;
  ['‚ù§Ô∏è','üòÇ','üòÆ','üò¢','üëç','üéâ'].forEach(emoji=>{
    const btn=document.createElement('div');
    btn.className='react-emoji';
    btn.textContent=emoji;
    btn.onclick=()=>{reactTo(id,emoji);picker.remove();};
    picker.appendChild(btn);
  });
  document.body.appendChild(picker);
  setTimeout(()=>picker.remove(),5000);
}

async function reactTo(msgId,emoji){
  try{
    const r=await fetch(`/api/messages/${msgId}/react`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({emoji})
    });
    const d=await r.json();
    if(!d.success)toast(d.error,'err');
  }catch(e){toast('Failed','err');}
}

// Context Menu
function showCtxMenu(event,id,isSent){
  event.preventDefault();
  event.stopPropagation();
  contextMsg={id,isSent};
  const menu=document.getElementById('ctxMenu');
  menu.style.left=`${event.clientX}px`;
  menu.style.top=`${event.clientY}px`;
  menu.classList.add('show');
  
  // Hide edit/delete for received messages
  const editItem = menu.querySelector('[onclick="editMsg()"]');
  const deleteItem = menu.querySelector('[onclick="deleteMsg()"]');
  if (editItem) editItem.style.display = isSent ? 'flex' : 'none';
  if (deleteItem) deleteItem.style.display = isSent ? 'flex' : 'none';
}
function hideCtxMenu(e){
  const menu = document.getElementById('ctxMenu');
  if (!e || !e.target.closest('#ctxMenu')) {
    menu.classList.remove('show');
  }
}
function replyToMsgCtx(){
  if(!contextMsg)return;
  const el=document.querySelector(`[data-msg-id="${contextMsg.id}"]`);
  if(el){
    const from=el.querySelector('.mfrom')?.textContent||ME_NAME;
    const bubText=el.querySelector('.bub')?.textContent?.trim()||'';
    const content=bubText.split('\n')[0]; // Get first line only
    setReply(contextMsg.id,from,content.substring(0,50));
  }
  hideCtxMenu();
}
function editMsgCtx(){
  if(!contextMsg||!contextMsg.isSent)return;
  const el=document.querySelector(`[data-msg-id="${contextMsg.id}"]`);
  if(el){
    const bubText=el.querySelector('.bub')?.textContent?.trim()||'';
    const content=bubText.split('\n')[0];
    startEdit(contextMsg.id,content);
  }
  hideCtxMenu();
}
function pinMsgCtx(){
  if(!contextMsg)return;
  togglePin(contextMsg.id);
  hideCtxMenu();
}
function deleteMsgCtx(){
  if(!contextMsg||!contextMsg.isSent)return;
  confirmDelete(contextMsg.id);
  hideCtxMenu();
}

// Search
function toggleSearch(){
  document.getElementById('searchPanel').classList.toggle('open');
  if(document.getElementById('searchPanel').classList.contains('open')){
    document.getElementById('msgSearch').focus();
  }
}
let searchMsgTimer=null;
function searchMsgs(q){
  clearTimeout(searchMsgTimer);
  if(!q.trim()){
    document.getElementById('searchResults').innerHTML='';
    return;
  }
  searchMsgTimer=setTimeout(()=>doSearchMsgs(q),300);
}
async function doSearchMsgs(q){
  if(!currentChatId)return;
  try{
    const r=await fetch(`/api/messages/search/${currentChatId}?q=${encodeURIComponent(q)}`);
    const d=await r.json();
    const results=document.getElementById('searchResults');
    if(!d.success||!d.messages.length){
      results.innerHTML='<div class="lempty" style="padding:12px;">No results</div>';
      return;
    }
    results.innerHTML=d.messages.map(m=>`
      <div class="search-msg" onclick="scrollToMsg(${m.id})">
        <div class="search-msg-from">${esc(m.sender_username)}</div>
        <div class="search-msg-content">${esc(m.content)}</div>
        <div class="search-msg-time">${fmtTime(m.created_at)}</div>
      </div>
    `).join('');
  }catch(e){}
}
function scrollToMsg(id){
  const el=document.querySelector(`[data-msg-id="${id}"]`);
  if(el){
    el.scrollIntoView({behavior:'smooth',block:'center'});
    el.style.background='rgba(124,106,255,.2)';
    setTimeout(()=>el.style.background='',2000);
  }
}

function toggleEmoji(){document.getElementById('epick').classList.toggle('open');}
function closeEmoji(){document.getElementById('epick').classList.remove('open');}
function ins(e){document.getElementById('msgInput').value+=e;document.getElementById('msgInput').focus();}
document.addEventListener('click',(e)=>{if(!e.target.closest('.epick')&&!e.target.closest('.isb'))closeEmoji();});

// Event delegation for message action buttons
document.addEventListener('click', (e) => {
  const btn = e.target.closest('.msg-act');
  if (!btn) return;
  
  const action = btn.dataset.action;
  const msgId = parseInt(btn.dataset.msgId);
  const msgEl = btn.closest('[data-msg-id]');
  
  if (!msgEl) return;
  
  const msgContent = msgEl.querySelector('.bub')?.textContent?.trim() || '';
  const msgFrom = msgEl.querySelector('.mfrom')?.textContent || ME_NAME;
  
  switch(action) {
    case 'reply':
      setReply(msgId, msgFrom, msgContent.substring(0, 50));
      break;
    case 'edit':
      startEdit(msgId, msgContent.split('\n')[0]);
      break;
    case 'pin':
      togglePin(msgId);
      break;
    case 'delete':
      confirmDelete(msgId);
      break;
    case 'react':
      showReactPicker(msgId, e);
      break;
  }
});

// Event delegation for reactions
document.addEventListener('click', (e) => {
  const reaction = e.target.closest('.reaction');
  if (!reaction) return;
  const msgEl = reaction.closest('[data-msg-id]');
  if (!msgEl) return;
  const msgId = parseInt(msgEl.dataset.msgId);
  const emoji = reaction.querySelector('span')?.textContent;
  if (emoji) reactTo(msgId, emoji);
});

function handleSearch(q){
  clearTimeout(searchTimer);const p=document.getElementById('srPanel');
  if(!q.trim()){p.classList.remove('open');return;}
  p.classList.add('open');
  document.getElementById('srList').innerHTML='<div class="lempty" style="padding:12px;">Searching‚Ä¶</div>';
  searchTimer=setTimeout(()=>doSearch(q),280);
}

async function doSearch(q){
  try{
    const r=await fetch(`/api/users/search?q=${encodeURIComponent(q)}`);
    const d=await r.json();
    const list=document.getElementById('srList');
    if(!d.success||!d.results.length){list.innerHTML='<div class="lempty" style="padding:12px;">No users found</div>';return;}
    list.innerHTML=d.results.map(u=>`
      <div class="sr-row">
        <div class="sr-l">
          <div class="av sm">${u.is_online?'<div class="online-dot"></div>':''}${u.username[0].toUpperCase()}</div>
          <div><div class="sr-nm">${esc(u.username)}</div><div class="sr-st">${u.is_online?'Online':esc(u.status)}</div></div>
        </div>
        ${srBtn(u)}
      </div>`).join('');
  }catch(e){console.error(e);}
}

function srBtn(u){
  if(u.relationship==='friend')return`<button class="pill p-msg" onclick="openChat(${u.id},'${esc(u.username)}')">Message</button>`;
  if(u.relationship==='request_sent')return`<button class="pill p-pend" disabled>Pending</button>`;
  if(u.relationship==='request_received')return`<button class="pill p-ok" onclick="quickAccept(${u.id})">Accept</button>`;
  return`<button class="pill p-add" onclick="addFriend(${u.id})">Add Friend</button>`;
}

async function loadFriends(){
  try{const r=await fetch('/api/friends');const d=await r.json();if(d.success){friends=d.friends;renderFriends();}}catch(e){}
}

function renderFriends(){
  const list=document.getElementById('clist');
  const empty=document.getElementById('cempty');
  list.querySelectorAll('.crow').forEach(e=>e.remove());
  if(!friends.length){empty.style.display='';return;}
  empty.style.display='none';
  friends.forEach(f=>{
    const el=document.createElement('div');
    el.className=`crow${currentChatId===f.chat_id?' active':''}`;
    el.onclick=()=>openChat(f.id,f.username,f.chat_id);
    const isOnline=onlineUsers.has(f.id);
    el.innerHTML=`<div class="av">${isOnline?'<div class="online-dot"></div>':''}${f.username[0].toUpperCase()}</div>
      <div class="cmeta">
        <div class="cnrow"><span class="cuname">${esc(f.username)}</span>${f.last_message_time?`<span class="cts">${relTime(f.last_message_time)}</span>`:''}</div>
        <div class="cprev">${f.last_message?esc(f.last_message):'No messages yet'}</div>
      </div>
      ${f.unread_count?`<div class="unread">${f.unread_count}</div>`:''}`;
    list.appendChild(el);
  });
}

function updateOnlineStatus(){
  if(currentFriendId&&onlineUsers.has(currentFriendId)){
    document.getElementById('chsub').textContent='Online';
    document.getElementById('chsub').classList.add('online');
  }else if(currentFriendId){
    document.getElementById('chsub').textContent='Friend';
    document.getElementById('chsub').classList.remove('online');
  }
  renderFriends();
}

function updatePrev(){loadFriends();}

async function loadRequests(){
  try{
    const r=await fetch('/api/friends/requests');const d=await r.json();if(!d.success)return;
    pendingReqs=d.received||[];
    const b=document.getElementById('rqBadge');
    if(pendingReqs.length){b.textContent=pendingReqs.length;b.classList.remove('hidden');}
    else b.classList.add('hidden');
    renderRequests();
  }catch(e){}
}

function renderRequests(){
  const list=document.getElementById('rqList');
  if(!pendingReqs.length){list.innerHTML='<div class="lempty" style="padding:12px;">No pending requests</div>';return;}
  list.innerHTML=pendingReqs.map(r=>`
    <div class="req-row">
      <div class="req-usr"><div class="av sm">${r.username[0].toUpperCase()}</div>
        <div><div class="req-nm">${esc(r.username)}</div><div class="req-wh">${r.time_ago||''}</div></div></div>
      <div class="req-ac">
        <button class="pill p-ok" onclick="acceptReq(${r.request_id})">Accept</button>
        <button class="pill p-no" onclick="rejectReq(${r.request_id})">Decline</button>
      </div>
    </div>`).join('');
}

function toggleP(id){
  const p=document.getElementById(id);p.classList.toggle('open');
  document.getElementById('rqBtn').classList.toggle('on',p.classList.contains('open'));
  if(id!=='srPanel')document.getElementById('srPanel').classList.remove('open');
}

async function addFriend(uid){
  try{
    const r=await fetch('/api/friends/request',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({to_user_id:uid})});
    const d=await r.json();
    if(d.success){toast('Friend request sent! üéâ','ok');clearSearch();}else toast(d.error,'err');
  }catch(e){toast('Failed','err');}
}

async function acceptReq(reqId){
  try{
    const r=await fetch('/api/friends/accept',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({request_id:reqId})});
    const d=await r.json();
    if(d.success){toast('Friend added! üéâ','ok');await loadFriends();await loadRequests();}else toast(d.error,'err');
  }catch(e){toast('Failed','err');}
}

async function rejectReq(reqId){
  try{await fetch('/api/friends/reject',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({request_id:reqId})});await loadRequests();}catch(e){}
}

async function quickAccept(userId){
  let rq=pendingReqs.find(r=>r.user_id===userId);
  if(!rq){await loadRequests();rq=pendingReqs.find(r=>r.user_id===userId);}
  if(rq)await acceptReq(rq.request_id);
}

function openChat(fid,fname,chatId){
  if(!chatId)chatId=fid<ME_ID?`${fid}-${ME_ID}`:`${ME_ID}-${fid}`;
  currentChatId=chatId;
  currentFriendId=fid;
  document.getElementById('chav').textContent=fname[0].toUpperCase();
  document.getElementById('chnm').textContent=fname;
  const isOnline=onlineUsers.has(fid);
  document.getElementById('chsub').textContent=isOnline?'Online':'Friend';
  document.getElementById('chsub').className=isOnline?'chdr-sub online':'chdr-sub';
  
  document.getElementById('searchBtn').style.display='block';
  document.getElementById('pinnedBtn').style.display='block';
  
  renderFriends();loadMsgs(chatId);
  if(socket?.connected)socket.emit('join_chat',{chat_id:chatId});
  clearSearch();
  if(window.innerWidth<=720)closeSB();
  if(window.innerWidth>720)document.getElementById('msgInput').focus();
}

function doTyping(){
  if(!currentChatId||!socket?.connected)return;
  socket.emit('typing_start',{chatId:currentChatId});
  clearTimeout(typingTimer);
  typingTimer=setTimeout(()=>socket.emit('typing_stop',{chatId:currentChatId}),2000);
}
function showTyping(name){document.getElementById('tytxt').textContent=`${name} is typing`;document.getElementById('tybar').style.display='flex';}
function hideTyping(){document.getElementById('tybar').style.display='none';}

function beep(){
  try{
    const ctx=new(window.AudioContext||window.webkitAudioContext)();
    const osc=ctx.createOscillator();const g=ctx.createGain();
    osc.connect(g);g.connect(ctx.destination);
    osc.frequency.value=880;
    g.gain.setValueAtTime(.1,ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(.0001,ctx.currentTime+.15);
    osc.start();osc.stop(ctx.currentTime+.15);
  }catch(e){}
}

function autoR(el){el.style.height='';el.style.height=Math.min(el.scrollHeight,110)+'px';}
function clearSearch(){document.getElementById('sinp').value='';document.getElementById('srPanel').classList.remove('open');document.getElementById('srList').innerHTML='';}
function toggleSB(){document.getElementById('sidebar').classList.toggle('open');document.getElementById('mov').classList.toggle('show');}
function closeSB(){document.getElementById('sidebar').classList.remove('open');document.getElementById('mov').classList.remove('show');}
async function logout(){await fetch('/api/auth/logout',{method:'POST'});window.location.href='/';}

function toast(msg,type=''){
  const s=document.getElementById('tstack');
  const el=document.createElement('div');el.className=`toast ${type}`;el.textContent=msg;
  s.appendChild(el);requestAnimationFrame(()=>requestAnimationFrame(()=>el.classList.add('show')));
  setTimeout(()=>{el.classList.remove('show');setTimeout(()=>el.remove(),220);},2800);
}

function toL(iso){const s=iso.endsWith('Z')||iso.includes('+')?iso:iso+'Z';return new Date(s);}
function fmtTime(iso){
  const d=toL(iso),now=new Date();
  const h=d.getHours(),m=String(d.getMinutes()).padStart(2,'0');
  const ap=h>=12?'PM':'AM',hh=String(h%12||12);
  const t=`${hh}:${m} ${ap}`;
  if(d.toDateString()===now.toDateString())return t;
  const y=new Date(now);y.setDate(now.getDate()-1);
  if(d.toDateString()===y.toDateString())return`Yesterday ${t}`;
  return`${d.getMonth()+1}/${d.getDate()} ${t}`;
}
function relTime(iso){const s=(Date.now()-toL(iso).getTime())/1000;if(s<60)return'now';if(s<3600)return`${Math.floor(s/60)}m`;if(s<86400)return`${Math.floor(s/3600)}h`;return`${Math.floor(s/86400)}d`;}
function dayLabel(iso){const d=toL(iso),now=new Date();if(d.toDateString()===now.toDateString())return'Today';const y=new Date(now);y.setDate(now.getDate()-1);if(d.toDateString()===y.toDateString())return'Yesterday';return d.toLocaleDateString(undefined,{month:'short',day:'numeric',year:'numeric'});}
function esc(s){if(!s)return'';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');}
</script>
</body>
</html>
