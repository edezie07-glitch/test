<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HPZ Messenger</title>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600&family=Space+Grotesk:wght@500;600&display=swap" rel="stylesheet">
<style>
/* ============================================================
   RESET & ROOT
============================================================ */
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --brand:     #6c63ff;
  --brand-dk:  #5a52d5;
  --brand-lt:  #ede9ff;
  --sent-bg:   #6c63ff;
  --recv-bg:   #ffffff;
  --sidebar-bg:#1e1e2e;
  --sidebar-lt:#2a2a3e;
  --sidebar-bd:#3a3a52;
  --chat-bg:   #f4f4f8;
  --text-main: #1a1a2e;
  --text-mute: #888;
  --green:     #22c55e;
  --red:       #ef4444;
  --radius:    14px;
  --trans:     0.18s ease;
}

html, body { height: 100%; overflow: hidden; }

body {
  font-family: 'DM Sans', sans-serif;
  background: var(--chat-bg);
  display: flex;
  height: 100vh;
  color: var(--text-main);
}

/* ============================================================
   SCROLLBAR
============================================================ */
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(108,99,255,.3); border-radius: 4px; }

/* ============================================================
   SIDEBAR
============================================================ */
.sidebar {
  width: 300px;
  min-width: 300px;
  background: var(--sidebar-bg);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  flex-shrink: 0;
}

/* --- Header --- */
.sidebar-header {
  padding: 18px 16px 14px;
  background: var(--sidebar-lt);
  border-bottom: 1px solid var(--sidebar-bd);
}

.sidebar-header-top {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 12px;
}

.app-title {
  font-family: 'Space Grotesk', sans-serif;
  font-size: 17px;
  color: #fff;
  display: flex;
  align-items: center;
  gap: 8px;
}

.app-title span.dot {
  width: 9px; height: 9px;
  background: var(--brand);
  border-radius: 50%;
  display: inline-block;
}

.header-actions {
  display: flex;
  gap: 6px;
}

.icon-btn {
  width: 34px; height: 34px;
  border-radius: 10px;
  border: none;
  background: rgba(255,255,255,.08);
  color: rgba(255,255,255,.8);
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  font-size: 16px;
  transition: background var(--trans);
  position: relative;
}
.icon-btn:hover { background: rgba(255,255,255,.15); }

.badge {
  position: absolute;
  top: -4px; right: -4px;
  background: var(--red);
  color: #fff;
  font-size: 9px;
  font-weight: 700;
  min-width: 16px; height: 16px;
  border-radius: 8px;
  display: flex; align-items: center; justify-content: center;
  padding: 0 3px;
}
.badge.hidden { display: none; }

/* --- Search --- */
.search-wrap {
  position: relative;
}
.search-wrap svg {
  position: absolute; left: 10px; top: 50%;
  transform: translateY(-50%);
  color: rgba(255,255,255,.35);
  pointer-events: none;
}
.search-input {
  width: 100%;
  padding: 9px 12px 9px 34px;
  background: rgba(255,255,255,.07);
  border: 1px solid transparent;
  border-radius: 10px;
  color: #fff;
  font-size: 13.5px;
  font-family: inherit;
  transition: border-color var(--trans), background var(--trans);
}
.search-input::placeholder { color: rgba(255,255,255,.3); }
.search-input:focus { outline: none; border-color: var(--brand); background: rgba(255,255,255,.1); }

/* --- Requests Panel --- */
.requests-panel {
  background: var(--sidebar-lt);
  border-bottom: 1px solid var(--sidebar-bd);
  max-height: 240px;
  overflow-y: auto;
  display: none;
}
.requests-panel.open { display: block; }
.requests-panel-title {
  padding: 10px 14px 6px;
  font-size: 11px;
  font-weight: 600;
  color: rgba(255,255,255,.4);
  text-transform: uppercase;
  letter-spacing: .08em;
}
.req-item {
  display: flex; align-items: center; justify-content: space-between;
  padding: 9px 14px;
  border-bottom: 1px solid rgba(255,255,255,.04);
}
.req-user { display: flex; align-items: center; gap: 9px; }
.req-name { font-size: 13.5px; color: rgba(255,255,255,.85); font-weight: 500; }
.req-time { font-size: 11px; color: rgba(255,255,255,.35); }
.req-btns { display: flex; gap: 5px; }

.pill-btn {
  padding: 4px 11px;
  border: none; border-radius: 20px;
  font-size: 11.5px; font-weight: 600; cursor: pointer;
  transition: opacity var(--trans);
}
.pill-btn:hover { opacity: .85; }
.pill-accept  { background: var(--green);  color: #fff; }
.pill-reject  { background: rgba(255,255,255,.1); color: rgba(255,255,255,.6); }
.pill-pending { background: rgba(255,255,255,.1); color: rgba(255,255,255,.4); cursor: default; }

/* --- Search Results --- */
.search-results {
  background: var(--sidebar-lt);
  border-bottom: 1px solid var(--sidebar-bd);
  max-height: 210px;
  overflow-y: auto;
  display: none;
}
.search-results.open { display: block; }
.sr-item {
  display: flex; align-items: center; justify-content: space-between;
  padding: 9px 14px;
  border-bottom: 1px solid rgba(255,255,255,.04);
  cursor: pointer;
  transition: background var(--trans);
}
.sr-item:hover { background: rgba(255,255,255,.04); }
.sr-user { display: flex; align-items: center; gap: 9px; }
.sr-name { font-size: 13.5px; color: rgba(255,255,255,.85); font-weight: 500; }
.sr-status { font-size: 11px; color: rgba(255,255,255,.35); }

.pill-add     { background: var(--brand);  color: #fff; }
.pill-message { background: rgba(108,99,255,.3); color: var(--brand); }

/* --- Chat List --- */
.chat-list {
  flex: 1;
  overflow-y: auto;
  padding: 6px 0;
}
.chat-list-label {
  padding: 10px 16px 4px;
  font-size: 10.5px;
  font-weight: 600;
  color: rgba(255,255,255,.3);
  text-transform: uppercase;
  letter-spacing: .08em;
}
.chat-item {
  display: flex; align-items: center; gap: 11px;
  padding: 10px 14px;
  cursor: pointer;
  border-radius: 10px;
  margin: 1px 6px;
  transition: background var(--trans);
  position: relative;
}
.chat-item:hover   { background: rgba(255,255,255,.05); }
.chat-item.active  { background: rgba(108,99,255,.2); }
.chat-item.active::before {
  content: '';
  position: absolute; left: 0; top: 20%; height: 60%;
  width: 3px; border-radius: 3px;
  background: var(--brand);
}
.chat-meta { flex: 1; min-width: 0; }
.chat-name-row { display: flex; justify-content: space-between; align-items: center; }
.chat-name { font-size: 13.5px; color: #fff; font-weight: 500; }
.chat-time { font-size: 10.5px; color: rgba(255,255,255,.3); }
.chat-preview { font-size: 12px; color: rgba(255,255,255,.35); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 1px; }

.empty-list {
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  height: 120px; gap: 6px;
  color: rgba(255,255,255,.25);
  font-size: 13px;
  text-align: center;
  padding: 0 20px;
}

/* --- Avatar --- */
.av {
  width: 38px; height: 38px; border-radius: 12px;
  background: var(--brand);
  color: #fff;
  display: flex; align-items: center; justify-content: center;
  font-weight: 700; font-size: 15px;
  flex-shrink: 0;
  overflow: hidden;
}
.av img { width: 100%; height: 100%; object-fit: cover; }
.av.sm { width: 32px; height: 32px; border-radius: 9px; font-size: 12px; }
.av.lg { width: 42px; height: 42px; border-radius: 13px; font-size: 17px; }

/* ============================================================
   MAIN CHAT AREA
============================================================ */
.main-chat {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  background: var(--chat-bg);
}

/* --- Chat Header --- */
.chat-header {
  padding: 14px 20px;
  background: #fff;
  border-bottom: 1px solid #e8e8f0;
  display: flex;
  align-items: center;
  gap: 12px;
  min-height: 64px;
}
.chat-header-info { flex: 1; min-width: 0; }
.chat-header-name { font-family: 'Space Grotesk', sans-serif; font-size: 15px; font-weight: 600; color: var(--text-main); }
.chat-header-sub  { font-size: 12px; color: var(--text-mute); margin-top: 1px; }
.chat-header-sub.online { color: var(--green); }

/* --- Messages --- */
.messages-area {
  flex: 1;
  overflow-y: auto;
  padding: 20px 20px 10px;
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.msg-day-divider {
  text-align: center;
  margin: 10px 0 6px;
}
.msg-day-divider span {
  background: rgba(0,0,0,.08);
  color: var(--text-mute);
  font-size: 11px;
  padding: 3px 10px;
  border-radius: 20px;
}

.msg-group { display: flex; flex-direction: column; }
.msg-group.sent  { align-items: flex-end; }
.msg-group.recv  { align-items: flex-start; }

.msg-sender-name {
  font-size: 11.5px; font-weight: 600;
  color: var(--brand);
  margin-bottom: 3px;
  margin-left: 2px;
}

.msg-bubble {
  max-width: 65%;
  padding: 10px 14px;
  border-radius: var(--radius);
  font-size: 14px;
  line-height: 1.5;
  word-break: break-word;
  position: relative;
}
.msg-group.sent .msg-bubble {
  background: var(--sent-bg);
  color: #fff;
  border-bottom-right-radius: 4px;
}
.msg-group.recv .msg-bubble {
  background: var(--recv-bg);
  color: var(--text-main);
  border-bottom-left-radius: 4px;
  box-shadow: 0 1px 4px rgba(0,0,0,.08);
}

.msg-bubble img {
  max-width: 260px; max-height: 260px;
  border-radius: 8px; display: block;
  cursor: pointer;
  margin-bottom: 4px;
}

.msg-time {
  font-size: 10px;
  margin-top: 4px;
  display: block;
}
.msg-group.sent  .msg-time { color: rgba(255,255,255,.6); text-align: right; }
.msg-group.recv  .msg-time { color: var(--text-mute); }

.chat-empty {
  flex: 1; display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  gap: 8px; color: var(--text-mute); text-align: center;
}
.chat-empty .emoji { font-size: 48px; margin-bottom: 4px; }
.chat-empty h3 { font-size: 17px; color: var(--text-main); }
.chat-empty p  { font-size: 13px; }

/* --- Typing indicator --- */
.typing-indicator {
  display: flex; align-items: center; gap: 4px;
  padding: 8px 14px;
  font-size: 12px; color: var(--text-mute);
  min-height: 28px;
}
.typing-dot {
  width: 6px; height: 6px;
  background: var(--text-mute);
  border-radius: 50%;
  animation: bounce 1.2s infinite;
}
.typing-dot:nth-child(2) { animation-delay: .2s; }
.typing-dot:nth-child(3) { animation-delay: .4s; }
@keyframes bounce {
  0%,60%,100% { transform: translateY(0); }
  30%          { transform: translateY(-5px); }
}

/* --- Input Area --- */
.input-area {
  padding: 12px 16px;
  background: #fff;
  border-top: 1px solid #e8e8f0;
  display: flex;
  align-items: center;
  gap: 10px;
}

.attach-btn {
  width: 38px; height: 38px;
  border-radius: 50%; border: none;
  background: var(--brand-lt);
  color: var(--brand);
  font-size: 17px;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
  transition: background var(--trans);
}
.attach-btn:hover { background: #d9d4ff; }

#msgInput {
  flex: 1;
  padding: 10px 16px;
  background: var(--chat-bg);
  border: 1px solid #e0e0ee;
  border-radius: 22px;
  font-size: 14px;
  font-family: inherit;
  outline: none;
  transition: border-color var(--trans);
  resize: none;
  line-height: 1.4;
  max-height: 120px;
}
#msgInput:focus { border-color: var(--brand); }
#msgInput::placeholder { color: #aaa; }

.send-btn {
  width: 40px; height: 40px;
  border-radius: 50%; border: none;
  background: var(--brand);
  color: #fff;
  font-size: 18px;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
  transition: background var(--trans), transform var(--trans);
}
.send-btn:hover   { background: var(--brand-dk); transform: scale(1.05); }
.send-btn:active  { transform: scale(.95); }
.send-btn:disabled { opacity: .45; cursor: not-allowed; transform: none; }

/* ============================================================
   TOAST
============================================================ */
.toast-wrap {
  position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
  z-index: 9999;
  display: flex; flex-direction: column; gap: 8px; align-items: center;
  pointer-events: none;
}
.toast {
  background: #1e1e2e;
  color: #fff;
  padding: 9px 18px;
  border-radius: 24px;
  font-size: 13px;
  box-shadow: 0 4px 16px rgba(0,0,0,.25);
  opacity: 0;
  transform: translateY(12px);
  transition: opacity .2s, transform .2s;
}
.toast.show { opacity: 1; transform: translateY(0); }
.toast.success { border-left: 3px solid var(--green); }
.toast.error   { border-left: 3px solid var(--red); }

/* ============================================================
   OVERLAY (mobile)
============================================================ */
.overlay {
  display: none;
  position: fixed; inset: 0;
  background: rgba(0,0,0,.5);
  z-index: 900;
}
.overlay.show { display: block; }

.mobile-toggle {
  display: none;
  position: fixed; top: 10px; left: 10px; z-index: 1001;
  width: 40px; height: 40px;
  border-radius: 12px; border: none;
  background: var(--brand); color: #fff;
  font-size: 20px; cursor: pointer;
  align-items: center; justify-content: center;
}

/* ============================================================
   RESPONSIVE
============================================================ */
@media (max-width: 720px) {
  .mobile-toggle { display: flex; }

  .sidebar {
    position: fixed; left: 0; top: 0; height: 100%;
    z-index: 950; width: 280px;
    transform: translateX(-100%);
    transition: transform .28s ease;
  }
  .sidebar.open { transform: translateX(0); }

  .main-chat { width: 100%; }

  .chat-header { padding-left: 58px; }

  .msg-bubble { max-width: 80%; }
}
</style>
</head>
<body>

<!-- Mobile overlay & toggle -->
<div class="overlay" id="overlay" onclick="closeSidebar()"></div>
<button class="mobile-toggle" onclick="toggleSidebar()">‚ò∞</button>

<!-- ============================================================
     SIDEBAR
============================================================ -->
<aside class="sidebar" id="sidebar">

  <!-- Header -->
  <div class="sidebar-header">
    <div class="sidebar-header-top">
      <div class="app-title">
        <span class="dot"></span>
        {{ user.username }}
      </div>
      <div class="header-actions">
        <button class="icon-btn" id="reqBtn" onclick="toggleRequests()" title="Friend requests">
          üîî
          <span class="badge hidden" id="reqBadge">0</span>
        </button>
        <button class="icon-btn" onclick="logout()" title="Logout">üö™</button>
      </div>
    </div>
    <!-- Search -->
    <div class="search-wrap">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      <input class="search-input" id="searchInput" type="text" placeholder="Search users‚Ä¶" oninput="handleSearch(this.value)" autocomplete="off">
    </div>
  </div>

  <!-- Friend Requests Panel -->
  <div class="requests-panel" id="requestsPanel">
    <div class="requests-panel-title">Friend Requests</div>
    <div id="requestsList"><div class="empty-list">No pending requests</div></div>
  </div>

  <!-- Search Results -->
  <div class="search-results" id="searchResults"></div>

  <!-- Chat / Friends List -->
  <div class="chat-list" id="chatList">
    <div class="chat-list-label">Conversations</div>
    <div class="empty-list" id="emptyList">
      <div>üë•</div>
      <div>Search for friends to start chatting</div>
    </div>
  </div>

</aside>

<!-- ============================================================
     MAIN CHAT
============================================================ -->
<main class="main-chat">

  <!-- Header -->
  <div class="chat-header" id="chatHeader">
    <div class="av lg" id="chatAv">üí¨</div>
    <div class="chat-header-info">
      <div class="chat-header-name" id="chatName">HPZ Messenger</div>
      <div class="chat-header-sub"  id="chatSub">Select a conversation</div>
    </div>
  </div>

  <!-- Messages -->
  <div class="messages-area" id="messagesArea">
    <div class="chat-empty">
      <div class="emoji">üí¨</div>
      <h3>No chat selected</h3>
      <p>Pick a friend from the sidebar to start messaging</p>
    </div>
  </div>

  <!-- Typing -->
  <div class="typing-indicator" id="typingIndicator" style="display:none;">
    <div class="typing-dot"></div>
    <div class="typing-dot"></div>
    <div class="typing-dot"></div>
    <span id="typingText" style="margin-left:4px;"></span>
  </div>

  <!-- Input -->
  <div class="input-area">
    <input type="file" id="imgInput" accept="image/*" style="display:none" onchange="uploadImage(this)">
    <button class="attach-btn" onclick="document.getElementById('imgInput').click()">üìé</button>
    <textarea id="msgInput" rows="1" placeholder="Type a message‚Ä¶"
              oninput="autoResize(this)"
              onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendMessage();}"></textarea>
    <button class="send-btn" id="sendBtn" onclick="sendMessage()">‚û§</button>
  </div>

</main>

<!-- Toast -->
<div class="toast-wrap" id="toastWrap"></div>

<!-- ============================================================
     JAVASCRIPT
============================================================ -->
<script>
// ‚îÄ‚îÄ Constants ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ME_ID   = {{ user_id }};
const ME_NAME = '{{ user.username }}';

// ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let socket        = null;
let currentChatId = null;
let friends       = [];
let pendingReqs   = [];
let searchTimer   = null;

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function init() {
  connectSocket();
  loadFriends();
  loadRequests();
})();

// ============================================================
// SOCKET
// ============================================================
function connectSocket() {
  socket = io({ withCredentials: true, transports: ['polling', 'websocket'] });

  socket.on('connect', () => {
    console.log('‚úÖ Socket connected:', socket.id);
    if (currentChatId) socket.emit('join_chat', { chat_id: currentChatId });
  });

  socket.on('disconnect', () => console.log('‚ùå Socket disconnected'));

  // ‚úÖ SINGLE handler ‚Äî no optimistic update anywhere = no duplicates
  socket.on('new_message', (msg) => {
    if (currentChatId && msg.chat_id === currentChatId) {
      appendMessage(msg);
    }
    refreshFriendPreview(msg);
  });

  socket.on('typing_start', ({ username }) => showTyping(username));
  socket.on('typing_stop',  ()             => hideTyping());

  socket.on('error', (e) => toast(e.message || 'Socket error', 'error'));
}

// ============================================================
// SEND MESSAGE  ‚Üê only one place, no optimistic update
// ============================================================
function sendMessage() {
  const input   = document.getElementById('msgInput');
  const content = input.value.trim();

  if (!content)        return;
  if (!socket?.connected) { toast('Not connected', 'error'); return; }
  if (!currentChatId)  { toast('Select a chat first', 'error'); return; }

  // Emit to server. Server broadcasts back. We receive via new_message handler.
  socket.emit('send_message', {
    chat_id:      currentChatId,
    content:      content,
    message_type: 'text'
  });

  input.value = '';
  input.style.height = '';
}

// ============================================================
// MESSAGES
// ============================================================
async function loadMessages(chatId) {
  try {
    const res  = await fetch(`/api/messages/${chatId}`);
    const data = await res.json();
    const area = document.getElementById('messagesArea');
    area.innerHTML = '';

    if (!data.success || !data.messages.length) {
      area.innerHTML = '<div class="chat-empty"><div class="emoji">üëã</div><h3>Say hello!</h3><p>No messages yet</p></div>';
      return;
    }

    let lastDay = '';
    data.messages.forEach(m => {
      const day = dayLabel(m.created_at);
      if (day !== lastDay) {
        area.insertAdjacentHTML('beforeend', `<div class="msg-day-divider"><span>${day}</span></div>`);
        lastDay = day;
      }
      appendMessage(m, false);
    });

    scrollBottom();
  } catch (e) { console.error(e); }
}

function appendMessage(msg, scroll = true) {
  const area   = document.getElementById('messagesArea');
  const empty  = area.querySelector('.chat-empty');
  if (empty) empty.remove();

  const isSent = msg.sender_id === ME_ID;
  const group  = document.createElement('div');
  group.className = `msg-group ${isSent ? 'sent' : 'recv'}`;

  let inner = '';
  if (!isSent) inner += `<div class="msg-sender-name">${esc(msg.sender_username)}</div>`;

  let body = '';
  if (msg.message_type === 'image') {
    body = `<img src="${msg.content}" alt="image" onclick="window.open('${msg.content}','_blank')">`;
  } else {
    body = esc(msg.content).replace(/\n/g, '<br>');
  }

  inner += `<div class="msg-bubble">${body}<span class="msg-time">${fmtTime(msg.created_at)}</span></div>`;
  group.innerHTML = inner;
  area.appendChild(group);
  if (scroll) scrollBottom();
}

function scrollBottom() {
  const a = document.getElementById('messagesArea');
  a.scrollTop = a.scrollHeight;
}

// ============================================================
// IMAGE UPLOAD
// ============================================================
async function uploadImage(input) {
  const file = input.files[0];
  if (!file) return;
  if (!currentChatId) { toast('Select a chat first', 'error'); input.value = ''; return; }

  const fd = new FormData();
  fd.append('image', file);

  try {
    const res  = await fetch('/api/upload/image', { method: 'POST', body: fd });
    const data = await res.json();
    if (data.success) {
      socket.emit('send_message', { chat_id: currentChatId, content: data.url, message_type: 'image' });
    } else {
      toast(data.error || 'Upload failed', 'error');
    }
  } catch (e) { toast('Upload failed', 'error'); }
  input.value = '';
}

// ============================================================
// SEARCH
// ============================================================
function handleSearch(q) {
  clearTimeout(searchTimer);
  const panel = document.getElementById('searchResults');

  if (!q.trim()) { panel.classList.remove('open'); panel.innerHTML = ''; return; }

  panel.classList.add('open');
  panel.innerHTML = '<div class="empty-list" style="padding:14px;">Searching‚Ä¶</div>';
  searchTimer = setTimeout(() => doSearch(q), 280);
}

async function doSearch(q) {
  try {
    const res  = await fetch(`/api/users/search?q=${encodeURIComponent(q)}`);
    const data = await res.json();
    const panel = document.getElementById('searchResults');

    if (!data.success || !data.results.length) {
      panel.innerHTML = '<div class="empty-list" style="padding:14px;">No users found</div>';
      return;
    }

    panel.innerHTML = data.results.map(u => `
      <div class="sr-item">
        <div class="sr-user">
          <div class="av sm">${u.username[0].toUpperCase()}</div>
          <div>
            <div class="sr-name">${esc(u.username)}</div>
            <div class="sr-status">${esc(u.status)}</div>
          </div>
        </div>
        ${searchBtn(u)}
      </div>
    `).join('');
  } catch (e) { console.error(e); }
}

function searchBtn(u) {
  if (u.relationship === 'friend') {
    return `<button class="pill-btn pill-message" onclick="openChat(${u.id},'${esc(u.username)}')">Message</button>`;
  }
  if (u.relationship === 'request_sent') {
    return `<button class="pill-btn pill-pending" disabled>Pending</button>`;
  }
  if (u.relationship === 'request_received') {
    return `<button class="pill-btn pill-accept" onclick="quickAccept(${u.id})">Accept</button>`;
  }
  return `<button class="pill-btn pill-add" onclick="addFriend(${u.id})">Add Friend</button>`;
}

// ============================================================
// FRIENDS
// ============================================================
async function loadFriends() {
  try {
    const res  = await fetch('/api/friends');
    const data = await res.json();
    if (data.success) { friends = data.friends; renderFriends(); }
  } catch (e) { console.error(e); }
}

function renderFriends() {
  const list  = document.getElementById('chatList');
  const empty = document.getElementById('emptyList');

  // Remove old friend items
  list.querySelectorAll('.chat-item').forEach(el => el.remove());

  if (!friends.length) { if (empty) empty.style.display = ''; return; }
  if (empty) empty.style.display = 'none';

  friends.forEach(f => {
    const active = currentChatId === f.chat_id;
    const el = document.createElement('div');
    el.className = `chat-item${active ? ' active' : ''}`;
    el.dataset.chatId = f.chat_id;
    el.onclick = () => openChat(f.id, f.username, f.chat_id);
    el.innerHTML = `
      <div class="av">${f.username[0].toUpperCase()}</div>
      <div class="chat-meta">
        <div class="chat-name-row">
          <span class="chat-name">${esc(f.username)}</span>
          ${f.last_message_time ? `<span class="chat-time">${relTime(f.last_message_time)}</span>` : ''}
        </div>
        <div class="chat-preview">${f.last_message ? esc(f.last_message) : 'No messages yet'}</div>
      </div>`;
    list.appendChild(el);
  });
}

function refreshFriendPreview(msg) {
  loadFriends(); // Reload sidebar previews after new message
}

// ============================================================
// FRIEND REQUESTS
// ============================================================
async function loadRequests() {
  try {
    const res  = await fetch('/api/friends/requests');
    const data = await res.json();
    if (!data.success) return;
    pendingReqs = data.received || [];

    const badge = document.getElementById('reqBadge');
    if (pendingReqs.length) {
      badge.textContent = pendingReqs.length;
      badge.classList.remove('hidden');
    } else {
      badge.classList.add('hidden');
    }
    renderRequests();
  } catch (e) { console.error(e); }
}

function renderRequests() {
  const list = document.getElementById('requestsList');
  if (!pendingReqs.length) {
    list.innerHTML = '<div class="empty-list" style="padding:14px;color:rgba(255,255,255,.3);">No pending requests</div>';
    return;
  }
  list.innerHTML = pendingReqs.map(r => `
    <div class="req-item">
      <div class="req-user">
        <div class="av sm">${r.username[0].toUpperCase()}</div>
        <div>
          <div class="req-name">${esc(r.username)}</div>
          <div class="req-time">${r.time_ago}</div>
        </div>
      </div>
      <div class="req-btns">
        <button class="pill-btn pill-accept" onclick="acceptReq(${r.request_id})">Accept</button>
        <button class="pill-btn pill-reject" onclick="rejectReq(${r.request_id})">Decline</button>
      </div>
    </div>`).join('');
}

function toggleRequests() {
  const panel = document.getElementById('requestsPanel');
  panel.classList.toggle('open');
  document.getElementById('searchResults').classList.remove('open');
}

async function addFriend(userId) {
  try {
    const res  = await fetch('/api/friends/request', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ to_user_id: userId })
    });
    const data = await res.json();
    if (data.success) {
      toast('Friend request sent! üéâ', 'success');
      clearSearch();
    } else {
      toast(data.error, 'error');
    }
  } catch (e) { toast('Failed to send request', 'error'); }
}

async function acceptReq(reqId) {
  try {
    const res  = await fetch('/api/friends/accept', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ request_id: reqId })
    });
    const data = await res.json();
    if (data.success) {
      toast('Friend added! üéâ', 'success');
      await loadFriends();
      await loadRequests();
    } else {
      toast(data.error, 'error');
    }
  } catch (e) { toast('Failed', 'error'); }
}

async function rejectReq(reqId) {
  try {
    await fetch('/api/friends/reject', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ request_id: reqId })
    });
    await loadRequests();
  } catch (e) {}
}

async function quickAccept(userId) {
  const req = pendingReqs.find(r => r.user_id === userId)
           || await fetchReqByUser(userId);
  if (req) await acceptReq(req.request_id);
}

async function fetchReqByUser(userId) {
  const res  = await fetch('/api/friends/requests');
  const data = await res.json();
  if (data.success) { pendingReqs = data.received; }
  return pendingReqs.find(r => r.user_id === userId) || null;
}

// ============================================================
// CHAT NAVIGATION
// ============================================================
function openChat(friendId, friendName, chatId) {
  if (!chatId) {
    chatId = friendId < ME_ID ? `${friendId}-${ME_ID}` : `${ME_ID}-${friendId}`;
  }

  currentChatId = chatId;

  document.getElementById('chatAv').textContent   = friendName[0].toUpperCase();
  document.getElementById('chatName').textContent  = friendName;
  document.getElementById('chatSub').textContent   = 'Friend';
  document.getElementById('chatSub').className     = 'chat-header-sub';

  renderFriends(); // Update active state
  loadMessages(chatId);

  if (socket?.connected) socket.emit('join_chat', { chat_id: chatId });
  clearSearch();
  if (window.innerWidth <= 720) closeSidebar();
}

// ============================================================
// TYPING
// ============================================================
let typingTimer = null;
document.getElementById('msgInput').addEventListener('input', () => {
  if (!currentChatId || !socket?.connected) return;
  socket.emit('typing_start', { chatId: currentChatId });
  clearTimeout(typingTimer);
  typingTimer = setTimeout(() => socket.emit('typing_stop', { chatId: currentChatId }), 2000);
});

function showTyping(name) {
  document.getElementById('typingText').textContent = `${name} is typing`;
  document.getElementById('typingIndicator').style.display = 'flex';
}
function hideTyping() {
  document.getElementById('typingIndicator').style.display = 'none';
}

// ============================================================
// MISC
// ============================================================
function autoResize(el) {
  el.style.height = '';
  el.style.height = Math.min(el.scrollHeight, 120) + 'px';
}

function clearSearch() {
  document.getElementById('searchInput').value = '';
  document.getElementById('searchResults').classList.remove('open');
  document.getElementById('searchResults').innerHTML = '';
}

function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('overlay').classList.toggle('show');
}
function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('overlay').classList.remove('show');
}

async function logout() {
  await fetch('/api/auth/logout', { method: 'POST' });
  window.location.href = '/';
}

// ============================================================
// TOAST
// ============================================================
function toast(msg, type = '') {
  const wrap = document.getElementById('toastWrap');
  const el   = document.createElement('div');
  el.className = `toast ${type}`;
  el.textContent = msg;
  wrap.appendChild(el);
  requestAnimationFrame(() => { requestAnimationFrame(() => el.classList.add('show')); });
  setTimeout(() => {
    el.classList.remove('show');
    setTimeout(() => el.remove(), 250);
  }, 2800);
}

// ============================================================
// DATE / TIME HELPERS
// ============================================================
function fmtTime(iso) {
    // Parse the UTC timestamp from server
    // If no timezone info, treat as UTC
    const utcStr = iso.endsWith('Z') || iso.includes('+') ? iso : iso + 'Z';
    const d   = new Date(utcStr);  // ‚Üê converts UTC ‚Üí local automatically
    const now = new Date();

    const h  = d.getHours();
    const m  = String(d.getMinutes()).padStart(2, '0');
    const ap = h >= 12 ? 'PM' : 'AM';
    const hh = String(h % 12 || 12);
    const timeStr = `${hh}:${m} ${ap}`;

    const sameDay = d.toDateString() === now.toDateString();
    if (sameDay) return timeStr;

    const yesterday = new Date(now);
    yesterday.setDate(now.getDate() - 1);
    if (d.toDateString() === yesterday.toDateString()) return `Yesterday ${timeStr}`;

    return `${d.getMonth() + 1}/${d.getDate()} ${timeStr}`;
}

function relTime(iso) {
  const s = (Date.now() - new Date(iso).getTime()) / 1000;
  if (s < 60)    return 'now';
  if (s < 3600)  return `${Math.floor(s/60)}m`;
  if (s < 86400) return `${Math.floor(s/3600)}h`;
  return `${Math.floor(s/86400)}d`;
}

function relTime(iso) {
    const utcStr = iso.endsWith('Z') || iso.includes('+') ? iso : iso + 'Z';
    const s = (Date.now() - new Date(utcStr).getTime()) / 1000;
    if (s < 60)    return 'now';
    if (s < 3600)  return `${Math.floor(s / 60)}m`;
    if (s < 86400) return `${Math.floor(s / 3600)}h`;
    return `${Math.floor(s / 86400)}d`;
}

function dayLabel(iso) {
    const utcStr = iso.endsWith('Z') || iso.includes('+') ? iso : iso + 'Z';
    const d   = new Date(utcStr);
    const now = new Date();
    if (d.toDateString() === now.toDateString()) return 'Today';
    const y = new Date(now);
    y.setDate(now.getDate() - 1);
    if (d.toDateString() === y.toDateString()) return 'Yesterday';
    return d.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
}


function esc(str) {
  if (!str) return '';
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
</script>
</body>
</html>
